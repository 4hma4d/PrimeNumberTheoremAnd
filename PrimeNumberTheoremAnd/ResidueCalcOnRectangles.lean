import Mathlib.Analysis.Complex.CauchyIntegral
import Mathlib.NumberTheory.VonMangoldt
import Mathlib.NumberTheory.ArithmeticFunction
import Mathlib.NumberTheory.ZetaFunction
import Mathlib.Analysis.Analytic.Meromorphic
import PrimeNumberTheoremAnd.EulerProducts.LSeries


open Complex BigOperators Finset Nat Classical Real Topology Filter

open scoped ArithmeticFunction Interval

/-%%

In this section, we develop residue calculus on rectangles for \emph{simple} poles.

\begin{definition}\label{Rectangle}\lean{Rectangle}\leanok
A Rectangle has corners $z$ and $w \in \C$.
\end{definition}
%%-/
/-- A `Rectangle` has corners `z` and `w`. -/
def Rectangle (z w : ‚ÑÇ) : Set ‚ÑÇ := [[z.re, w.re]] √ó‚ÑÇ [[z.im, w.im]]

/-%%
\begin{definition}\label{RectangleIntegral}\lean{RectangleIntegral}\leanok
A RectangleIntegral of a function $f$ is one over a rectangle determined by $z$ and $w$ in $\C$.
We will sometimes denote it by $\int_{z}^{w} f$. (There is also a primed version, which is $1/(2\pi i)$ times the original.)
\end{definition}
%%-/
/-- A `RectangleIntegral` of a function `f` is one over a rectangle determined by
  `z` and `w` in `‚ÑÇ`. -/
noncomputable def RectangleIntegral (f : ‚ÑÇ ‚Üí ‚ÑÇ) (z w : ‚ÑÇ) : ‚ÑÇ :=
    ((‚à´ x : ‚Ñù in z.re..w.re, f (x + z.im * I)) - (‚à´ x : ‚Ñù in z.re..w.re, f (x + w.im * I))
     + I ‚Ä¢ (‚à´ y : ‚Ñù in z.im..w.im, f (w.re + y * I)) - I ‚Ä¢ ‚à´ y : ‚Ñù in z.im..w.im, f (z.re + y * I))

noncomputable abbrev RectangleIntegral' (f : ‚ÑÇ ‚Üí ‚ÑÇ) (z w : ‚ÑÇ) : ‚ÑÇ :=
    (1/(2 * œÄ * I)) * RectangleIntegral f z w

/-%%
The border of a rectangle is the union of its four sides.
\begin{definition}\label{RectangleBorder}\lean{RectangleBorder}\leanok
A Rectangle's border, given corners $z$ and $w$ is the union of the four sides.
\end{definition}
%%-/
/-- A `RectangleBorder` has corners `z` and `w`. -/
def RectangleBorder (z w : ‚ÑÇ) : Set ‚ÑÇ := [[z.re, w.re]] √ó‚ÑÇ {z.im} ‚à™ {z.re} √ó‚ÑÇ [[z.im, w.im]] ‚à™ [[z.re, w.re]] √ó‚ÑÇ {w.im} ‚à™ {w.re} √ó‚ÑÇ [[z.im, w.im]]

/-- A function is `HolomorphicOn` a set if it is complex differentiable on that set. -/
abbrev HolomorphicOn {E : Type*} [NormedAddCommGroup E] [NormedSpace ‚ÑÇ E] (f : ‚ÑÇ ‚Üí E) (s : Set ‚ÑÇ) :
    Prop := DifferentiableOn ‚ÑÇ f s


/-%%
\begin{theorem}\label{existsDifferentiableOn_of_bddAbove}\lean{existsDifferentiableOn_of_bddAbove}\leanok
If $f$ is differentiable on a set $s$ except at $c\in s$, and $f$ is bounded above on $s\setminus\{c\}$, then there exists a differentiable function $g$ on $s$ such that $f$ and $g$ agree on $s\setminus\{c\}$.
\end{theorem}
%%-/
theorem existsDifferentiableOn_of_bddAbove {E : Type*} [NormedAddCommGroup E] [NormedSpace ‚ÑÇ E]
    [CompleteSpace E] {f : ‚ÑÇ ‚Üí E} {s : Set ‚ÑÇ} {c : ‚ÑÇ} (hc : s ‚àà nhds c)
    (hd : HolomorphicOn f (s \ {c})) (hb : BddAbove (norm ‚àò f '' (s \ {c}))) :
    ‚àÉ (g : ‚ÑÇ ‚Üí E), HolomorphicOn g s ‚àß (Set.EqOn f g (s \ {c})) := by
  refine ‚ü®(Function.update f c (limUnder (nhdsWithin c {c}·∂ú) f)),
    differentiableOn_update_limUnder_of_bddAbove hc hd hb, ?_‚ü©
  intro z hz
  by_cases h : z = c
  ¬∑ exfalso
    simp only [Set.mem_diff, Set.mem_singleton_iff] at hz
    exact hz.2 h
  ¬∑ simp [h]
/-%%
\begin{proof}\leanok
This is the Reimann Removable Singularity Theorem, slightly rephrased from what's in Mathlib. (We don't care what the function $g$ is, just that it's holomorphic.)
\end{proof}
%%-/

/-%%
\begin{theorem}\label{HolomorphicOn.vanishesOnRectangle}\lean{HolomorphicOn.vanishesOnRectangle}\leanok
If $f$ is holomorphic on a rectangle $z$ and $w$, then the integral of $f$ over the rectangle with corners $z$ and $w$ is $0$.
\end{theorem}
%%-/
theorem HolomorphicOn.vanishesOnRectangle {f : ‚ÑÇ ‚Üí ‚ÑÇ} {U : Set ‚ÑÇ} {z w : ‚ÑÇ}
    (f_holo : HolomorphicOn f U) (hU : Rectangle z w ‚äÜ U) :
    RectangleIntegral f z w = 0 := by sorry -- mathlib4\#9598
/-%%
\begin{proof}\leanok
This is in a Mathlib PR.
\end{proof}
%%-/


/-%%
The next lemma allows to zoom a big rectangle down to a small square, centered at a pole.

\begin{lemma}\label{RectanglePullToNhdOfPole}\lean{RectanglePullToNhdOfPole}\leanok
If $f$ is holomorphic on a rectangle $z$ and $w$ except at a point $p$, then the integral of $f$
over the rectangle with corners $z$ and $w$ is the same as the integral of $f$ over a small square
centered at $p$.
\end{lemma}
%%-/
lemma RectanglePullToNhdOfPole {f : ‚ÑÇ ‚Üí ‚ÑÇ} {z w p : ‚ÑÇ} (pInRectInterior : Rectangle z w ‚àà nhds p)
    (fHolo : HolomorphicOn f (Rectangle z w \ {p})) :
    ‚àÄ·∂† (c : ‚Ñù) in ùìù[>]0, RectangleIntegral f z w =
      RectangleIntegral f (-c - I * c + p) (c + I * c + p) := by sorry
/-%%
\begin{proof}\uses{HolomorphicOn.vanishesOnRectangle}
Chop the big rectangle with two vertical cuts and two horizontal cuts into nine smaller rectangles,
the middle one being the desired square. The integral over each of the eight outer rectangles
vanishes, since $f$ is holomorphic there. (The constant $c$ being ``small enough'' here just means
that the inner square is strictly contained in the big rectangle.)
\end{proof}
%%-/


/-%%
\begin{lemma}\label{ResidueTheoremAtOrigin}
\lean{ResidueTheoremAtOrigin}\leanok
The rectangle (square) integral of $f(s) = 1/s$ with corners $-1-i$ and $1+i$ is equal to $2\pi i$.
\end{lemma}
%%-/
lemma ResidueTheoremAtOrigin :
    RectangleIntegral' (fun s ‚Ü¶ 1 / s) (-1 - I) (1 + I) = 1 := by
  sorry
/-%%
\begin{proof}
The bottom is:
$$
\frac1{2\pi i}
\int_{-1-i}^{1-i} \frac1z dz
=
\frac1{2\pi i}
\int_{-1}^1 \frac1{x-i} dx,
$$
and the top is the negative of:
$$
\frac1{2\pi i}
\int_{-1+i}^{1+i} \frac1z dz
=
\frac1{2\pi i}
\int_{-1}^1 \frac1{x+i} dx.
$$
The two together add up to:
$$
\frac1{2\pi i}
\int_{-1}^1
\left(\frac1{x-i}-\frac1{x+i} \right)dx
=
\frac1{\pi}
\int_{-1}^1
\frac{1}{x^2+1}dx,
$$
which is the arctan at $1$ (namely $\pi/4$) minus that at $-1$. In total, this contributes $1/2$ to the integral.

The vertical sides are:
$$
\frac1{2\pi i}
\int_{1-i}^{1+i} \frac1z dz
=
\frac1{2\pi}
\int_{-1}^1 \frac1{1+iy} dy
$$
and the negative of
$$
\frac1{2\pi i}
\int_{-1-i}^{-1+i} \frac1z dz
=
\frac1{2\pi}
\int_{-1}^1 \frac1{-1+iy} dy.
$$
This difference comes out to:
$$
\frac1{2\pi}
\int_{-1}^1 \left(\frac1{1+iy}-\frac1{-1+iy}\right) dy
=
\frac1{2\pi}
\int_{-1}^1 \left(\frac{-2}{-1-y^2}\right) dy,
$$
which contributes another factor of $1/2$. (Fun! Each of the vertical/horizontal sides contributes half of the winding.)
\end{proof}
%%-/

/-%%
\begin{lemma}\label{ResidueTheoremOnRectangleWithSimplePole}
\lean{ResidueTheoremOnRectangleWithSimplePole}\leanok
Suppose that $f$ is a holomorphic function on a square centered on $p$, except for a simple pole
at $p$. By the latter, we mean that there is a function $g$ holomorphic on the square such that,
in the square, we have $f = g + A/(s-p)$ for some $A\in\C$. Then the integral of $f$ over the
square is $A$.
\end{lemma}
%%-/
lemma ResidueTheoremOnRectangleWithSimplePole {f g : ‚ÑÇ ‚Üí ‚ÑÇ} {p A : ‚ÑÇ} {c : ‚Ñù} (cpos : 0 < c)
    (fHolo : HolomorphicOn f (Rectangle (-c - I * c + p) (c + I * c + p) \ {p}))
    (gHolo : HolomorphicOn g (Rectangle (-c - I * c + p) (c + I * c + p)))
    (principalPart : Set.EqOn f (g + fun s ‚Ü¶ A / (s - p))
      (Rectangle (-c - I * c + p) (c + I * c + p) \ {p})) :
    RectangleIntegral' f (-c - I * c + p) (c + I * c + p) = A := by

  sorry
/-%%
\begin{proof}\uses{ResidueTheoremAtOrigin}
Replace $f$ with $g + A/(s-p)$ in the integral.
The integral of $g$ vanishes. To evaluate the square integral of $1/(s-p)$,
pull everything to the origin, and rescale by $c$; what remains is handled by Lemma \ref{ResidueTheoremAtOrigin}.
\end{proof}
%%-/
